# 동시성 문제 보고서

## 개요

커머스 서비스에서 발생할 수 있는 동시성 문제를 분석하고, 이를 해결하기 위한 방안을 제시합니다.

## 발생 가능한 동시성 문제

### 1. 상품 재고 차감

**문제 상황 식별**
- 동시에 여러 사용자가 같은 상품을 주문할 때 발생

**발생 시나리오 분석**
```
상품 A의 재고: 10개

사용자 1: 재고 확인 (10개) → 주문 처리 중
사용자 2: 재고 확인 (10개) → 주문 처리 중
사용자 1: 재고 차감 (10 - 5 = 5개)
사용자 2: 재고 차감 (5 - 8 = -3개) ← 문제 발생!
```

**해결 방법**
- 비관적 락을 사용합니다.
- 하나의 상품에 대하여 여러 명의 사람들의 동시에 접근할 수 있기 때문에 비관적 락을 사용해야 합니다.

### 2. 포인트 충전 및 사용

**문제 상황 식별**
- 동시에 여러 거래(충전/사용)가 발생할 때 잔액의 정합성 문제

**발생 시나리오 분석**
```
사용자 잔액: 10,000원

거래 1: 잔액 확인 (10,000원) → 결제 처리 중
거래 2: 잔액 확인 (10,000원) → 결제 처리 중
거래 1: 잔액 차감 (10,000 - 8,000 = 2,000원)
거래 2: 잔액 차감 (2,000 - 5,000 = -3,000원) ← 문제 발생!
```

**해결 방법**
- 낙관적 락 사용 (JPA @Version 어노테이션 활용)
- Balance 엔티티에 version 컬럼을 추가하여 낙관적 락을 구현했습니다.
- 하나의 포인트 자원에 대하여 한명의 유저만 접근이 가능하고, 해당 유저가 포인트 충전과 사용(상품 주문) 을 동시에 할 일은 보편적인 관점에서 없다고 생각이 들었습니다. 
- 한개의 아이디를 여러명이 돌려서 사용하는 경우에 대해서는 상정하지 않았습니다. 비즈니스 정책이 동시 로그인을 제한하는 방향으로 해결할 수 있다고 생각합니다.

### 3. 쿠폰 발급 동시성 문제

**문제 상황 식별**
- 선착순 쿠폰 발급 시 동시 요청으로 인한 수량 초과 발급

**발생 시나리오 분석**
```
쿠폰 총 수량: 100개, 현재 발급 수량: 99개

사용자 1: 발급 수량 확인 (99개) → 발급 처리 중
사용자 2: 발급 수량 확인 (99개) → 발급 처리 중
사용자 1: 발급 수량 증가 (99 + 1 = 100개)
사용자 2: 발급 수량 증가 (100 + 1 = 101개) ← 문제 발생!
```

**해결 방법**
- 비관적 락 사용
- 하나의 쿠폰 자원에 대하여 여러 명의 유저가 접근이 가능하므로 비관적 락을 사용해야 합니다.
- 실무에서는 해당 시나리오의 TPS가 매우 높을 것으로 판단이 되어 추후 Redis 를 사용하여 발급 가능한 쿠폰 수를 incr 하고, kafka 같이 push 기반의 큐 시스템을 사용하여 데이터를 저장해야 할 것 같습니다. (단일 장애 지점 분리 및 성능 향상을 위함)
