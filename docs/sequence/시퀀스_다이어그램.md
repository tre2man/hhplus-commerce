### 잔액 조회

```mermaid
sequenceDiagram
    autonumber
    participant BalanceController
    participant BalanceFacade
    participant BalanceService
    participant BalanceRepository

    BalanceController->>BalanceFacade: 잔액 조회
    BalanceFacade->>BalanceService: 잔액 조회
    BalanceService->>BalanceRepository: 잔액 조회
    BalanceRepository-->>BalanceService: 잔액 반환
    BalanceService-->>BalanceFacade: 잔액 반환
    BalanceFacade-->>BalanceController: 잔액 반환
```

### 잔액 충전

```mermaid
sequenceDiagram
    autonumber
    participant BalanceController
    participant BalanceInterceptor
    participant BalanceFacade
    participant BalanceService
    participant BalanceRepository

    BalanceController->>BalanceInterceptor: 잔액 충전량 검증
    alt 잔액 충전 요구사항 위반
        BalanceInterceptor->>BalanceController: 잔액 충전 요청값 에러
    end
    BalanceController->>BalanceFacade: 잔액 충전 요청
    BalanceFacade->>BalanceService: 잔액 충전 요청
    BalanceService->>BalanceRepository: 남은 잔액 확인
    BalanceRepository-->>BalanceService: 남은 잔액 반환
    BalanceService->>BalanceService: 잔액 추가
    BalanceService->>BalanceService: 초과 잔액 검증
    alt 남은 잔액량 초과
        BalanceService->>BalanceController: 최대 잔액 초과 에러
    end
    BalanceService->>BalanceRepository: 추가된 잔액 저장
    BalanceRepository-->>BalanceService: 추가된 잔액 반환
    BalanceService-->>BalanceFacade: 추가된 잔액 반환
    BalanceFacade-->>BalanceController: 추가된 잔액 반환
```

### 상품 조회

```mermaid
sequenceDiagram
    autonumber
    participant ProductController
    participant ProductFacade
    participant ProductService
    participant ProductRepository

    ProductController->>ProductFacade: 상품 조회 요청
    ProductFacade->>ProductService: 상품 조회 요청
    ProductService->>ProductRepository: 상품 조회
    ProductRepository-->>ProductService: 상품 반환
    alt 상품 없음
        ProductService-->>ProductController: 에러 반환
    end
    ProductService-->>ProductFacade: 상품 반환
    ProductFacade-->>ProductController: 상품 반환
```

### 주문/결제

```mermaid
sequenceDiagram
    autonumber
    participant OrderController
    participant OrderFacade
    participant OrderService
    participant ProductService
    participant BalanceService
    participant CouponService
    participant OrderRepository
    participant DataPlatformService

    OrderController->>OrderFacade: 결제 요청 진행
    OrderFacade->>OrderService: 결제 요청 진행
    OrderService->>ProductService: 재고 현황 확인
    ProductService-->>OrderService: 재고 현황 반환
    alt 재고 없음
        OrderService-->>OrderController: 재고 미달 에러 반환
    end
    OrderService->>BalanceService: 잔액 확인
    BalanceService-->>OrderService: 잔액 반환
    alt 잔액 없음
        OrderService-->>OrderController: 잔액 미달 에러 반환
    end
    alt 쿠폰 사용 요청이 존재할 경우
        OrderService->>CouponService: 쿠폰 유효성 확인
        CouponService-->>OrderService: 쿠폰 유효성 반환
        alt 쿠폰이 유효하지 않을 경우
            OrderService-->>OrderController: 쿠폰 유효성 에러 반환
        end
    end
    OrderService->>BalanceService: 잔액 차감
    BalanceService-->>OrderService: 차감된 잔액 반환
    OrderService->>ProductService: 재고 감소
    ProductService-->>OrderService: 재고 감소 결과 반환
    alt 쿠폰 사용 요청이 존재할 경우
        OrderService->>CouponService: 쿠폰 사용
        CouponService-->>OrderService: 쿠폰 사용 결과 반환
    end
    OrderService->>OrderRepository: 구매 기록 저장
    OrderRepository->>OrderService: 구매 기록 반환
    OrderService->DataPlatformService: 구매 정보 저장
    OrderService-->>OrderFacade: 주문 결과 반환
    OrderFacade-->>OrderController: 주문 결과 반환
```

### 쿠폰 조회

```mermaid
sequenceDiagram
    autonumber
    participant CouponController
    participant CouponFacade
    participant CouponService
    participant IssuedCouponRepository

    CouponController->>CouponFacade: 쿠폰 조회
    CouponFacade->>CouponService: 쿠폰 조회
    CouponService->>IssuedCouponRepository: 쿠폰들 조회
    IssuedCouponRepository-->>CouponService: 쿠폰들 반환
    CouponService-->>CouponFacade: 쿠폰들 반환
    CouponFacade-->>CouponController: 쿠폰들 반환
```

### 선착순 쿠폰 발급

```mermaid
sequenceDiagram
    autonumber
    participant CouponController
    participant CouponFacade
    participant CouponService
    participant CouponRepository
    participant IssuedCouponRepository

    CouponController->>CouponFacade: 쿠폰 요청
    CouponFacade->>CouponService: 쿠폰 요청
    CouponService->>CouponRepository: 발행 가능한 쿠폰 확인
    CouponRepository-->>CouponService: 발행 가능한 쿠폰 반환
    alt 발행 가능한 쿠폰 없을 경우
        CouponService-->>CouponController: 쿠폰 에러 반환
    end
    CouponService->>IssuedCouponRepository: 쿠폰 저장
    IssuedCouponRepository-->>CouponService: 쿠폰 저장 결과 반환
    CouponService->>CouponRepository: 발행 가능한 쿠폰 개수 차감
    CouponRepository-->>CouponService: 발행 가능한 쿠폰 개수 결과
    CouponService-->>CouponFacade: 적용된 쿠폰 반환
    CouponFacade-->>CouponController: 적용된 쿠폰 반환
```

### 인기 판매 상품 조회

```mermaid
sequenceDiagram
    autonumber
    participant ProductController
    participant ProductFacade
    participant ProductService
    participant OrderHistoryService

    ProductController->>ProductFacade: 인기 상품 호출
    ProductFacade->>ProductService: 인기 상품 호출
    ProductService->>OrderHistoryService: 인기 상품 호출
    OrderHistoryService-->>ProductService: 인기 상품 반환
    ProductService-->>ProductFacade: 인기 상품 
    ProductFacade-->>ProductController: 인기 상품 반환
```
